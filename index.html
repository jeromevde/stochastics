<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stochastic Processes in Finance â€” Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
/* â”€â”€â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #ffffff;
  --surface: #ffffff;
  --surface2: #f1f5fb;
  --border: #e2e8f0;
  --text: #111827;
  --text-dim: #6b7280;
  --primary: #6c8cff;
  --primary-hover: #8aa4ff;
  --correct: #34d399;
  --correct-bg: rgba(52, 211, 153, .12);
  --wrong: #f87171;
  --wrong-bg: rgba(248, 113, 113, .12);
  --radius: 10px;
  --radius-lg: 16px;
}

html { font-size: 17px; }
body {
  font-family: 'Inter', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  padding: 1.5rem;
}

/* â”€â”€â”€â”€â”€ Views â”€â”€â”€â”€â”€ */
.view { display: none; max-width: 800px; margin: 0 auto; }
.view.active { display: block; }
#quizView { max-width: none; width: 100%; }

/* â”€â”€â”€â”€â”€ Landing â”€â”€â”€â”€â”€ */
.hero { text-align: center; padding: 3rem 0 2rem; }
.hero h1 { font-size: 2rem; font-weight: 700; letter-spacing: -.02em; }
.hero .subtitle { color: var(--text-dim); margin-top: .5rem; font-size: 1.05rem; }

.chapter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 1rem;
  margin-top: 1.5rem;
}

.chapter-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.25rem;
  transition: border-color .15s, transform .15s;
}
.chapter-card:hover { border-color: var(--primary); transform: translateY(-2px); }
.chapter-card h3 { font-size: .95rem; font-weight: 600; }
.chapter-card .meta { color: var(--text-dim); font-size: .82rem; margin-top: .35rem; }
.chapter-card .bar-bg {
  height: 4px; background: var(--surface2); border-radius: 2px; margin-top: .75rem; overflow: hidden;
}
.chapter-card .bar-fill {
  height: 100%; background: var(--primary); border-radius: 2px; transition: width .3s;
}
.chapter-actions {
  display: flex; gap: .5rem; margin-top: .75rem;
}
.chapter-actions .btn {
  flex: 1; font-size: .82rem; padding: .5rem .75rem;
}
.btn-study {
  background: var(--surface2); color: var(--text);
  border: 1px solid var(--border);
}
.btn-study:hover {
  background: var(--surface);
  border-color: var(--primary);
  color: var(--primary);
}

.cta-row { text-align: center; margin-top: 2rem; padding-bottom: 2rem; }

/* â”€â”€â”€â”€â”€ Jump Navigation â”€â”€â”€â”€â”€ */
.jump-nav {
  display: flex; flex-wrap: wrap; gap: .35rem;
  padding: .5rem 0 .25rem; max-width: none;
}
.jump-btn {
  min-width: 30px; height: 30px; padding: 0 .35rem;
  font-size: .75rem; font-weight: 600;
  border: 1px solid var(--border); border-radius: 6px;
  background: var(--surface2); color: var(--text-dim);
  cursor: pointer;
  display: inline-flex; align-items: center; justify-content: center;
  transition: all .12s;
}
.jump-btn:hover { border-color: var(--primary); color: var(--primary); }
.jump-btn.current { border-color: var(--primary); background: rgba(108,140,255,.12); color: var(--primary); }
.jump-btn.answered-correct { border-color: var(--correct); background: var(--correct-bg); color: #1a7a5a; }
.jump-btn.answered-wrong { border-color: var(--wrong); background: var(--wrong-bg); color: #b84040; }

/* â”€â”€â”€â”€â”€ Buttons â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  font-family: inherit; font-weight: 600; font-size: .9rem;
  border: none; border-radius: var(--radius); cursor: pointer;
  padding: .6rem 1.3rem; transition: background .15s, color .15s;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
.btn-ghost:hover { color: var(--text); border-color: var(--text-dim); }
.btn-lg { font-size: 1rem; padding: .75rem 2rem; }

/* â”€â”€â”€â”€â”€ Quiz Header â”€â”€â”€â”€â”€ */
.quiz-header {
  display: flex; align-items: center; gap: 1rem;
  padding: .75rem 0; margin-bottom: 1rem;
  flex-wrap: wrap;
}
.progress-wrap {
  flex: 1; height: 6px; background: var(--surface2);
  border-radius: 3px; overflow: hidden; min-width: 100px;
}
.progress-bar { height: 100%; background: var(--primary); border-radius: 3px; transition: width .3s; }
.progress-text { font-size: .85rem; color: var(--text-dim); white-space: nowrap; }
.score-text { font-size: .85rem; color: var(--primary); font-weight: 600; white-space: nowrap; }
#nextBtn { margin-left: auto; }

/* â”€â”€â”€â”€â”€ Question Card â”€â”€â”€â”€â”€ */
.question-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 2rem;
}
.q-badge {
  display: inline-block; font-size: .75rem; font-weight: 600;
  color: var(--primary); background: rgba(108,140,255,.12);
  padding: .2rem .6rem; border-radius: 6px; margin-bottom: .75rem;
}
.q-text { font-size: 1.1rem; font-weight: 500; line-height: 1.55; margin-bottom: 1.5rem; }

/* â”€â”€â”€â”€â”€ Options (MC) â”€â”€â”€â”€â”€ */
.options { display: flex; flex-direction: column; gap: .6rem; }

.option-btn {
  display: flex; align-items: flex-start; gap: .75rem;
  width: 100%; text-align: left;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: .8rem 1rem;
  font-family: inherit; font-size: .95rem; color: var(--text);
  cursor: pointer; transition: border-color .15s, background .15s;
  line-height: 1.5;
}
.option-btn:hover:not(.disabled) { border-color: var(--primary); }
.option-btn .letter {
  flex-shrink: 0; width: 26px; height: 26px; line-height: 26px;
  text-align: center; border-radius: 50%;
  font-weight: 600; font-size: .8rem;
  background: var(--border); color: var(--text);
}
.option-btn.selected { border-color: var(--primary); background: rgba(108,140,255,.08); }
.option-btn.correct { border-color: var(--correct); background: var(--correct-bg); }
.option-btn.correct .letter { background: var(--correct); color: #fff; }
.option-btn.wrong { border-color: var(--wrong); background: var(--wrong-bg); }
.option-btn.wrong .letter { background: var(--wrong); color: #fff; }
.option-btn.disabled { pointer-events: none; opacity: .85; }
.option-btn.dimmed { opacity: .5; }

/* â”€â”€â”€â”€â”€ Numeric â”€â”€â”€â”€â”€ */
.numeric-wrap { display: flex; align-items: center; gap: .75rem; flex-wrap: wrap; }
.numeric-wrap label { font-size: .95rem; color: var(--text-dim); }
.numeric-wrap input {
  font-family: inherit; font-size: 1rem; padding: .5rem .75rem;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text); width: 140px;
}
.numeric-wrap input:focus { outline: none; border-color: var(--primary); }

/* â”€â”€â”€â”€â”€ Explanation â”€â”€â”€â”€â”€ */
.explanation {
  margin-top: 1.25rem; padding: 1rem 1.25rem;
  border-radius: var(--radius); font-size: .93rem; line-height: 1.6;
}
.explanation.correct-expl { background: var(--correct-bg); border-left: 3px solid var(--correct); }
.explanation.wrong-expl { background: var(--wrong-bg); border-left: 3px solid var(--wrong); }
.explanation-header { font-weight: 700; margin-bottom: .35rem; }
.explanation-header.correct-hdr { color: var(--correct); }
.explanation-header.wrong-hdr { color: var(--wrong); }

.hidden { display: none !important; }

/* â”€â”€â”€â”€â”€ Results â”€â”€â”€â”€â”€ */
.results-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 2.5rem; text-align: center;
  margin-top: 2rem;
}
.results-card h2 { font-size: 1.5rem; margin-bottom: 1rem; }
.results-score {
  font-size: 3rem; font-weight: 700; color: var(--primary); margin-bottom: .5rem;
}
.results-breakdown {
  margin: 1.5rem auto; max-width: 400px; text-align: left;
}
.results-breakdown .row {
  display: flex; justify-content: space-between;
  padding: .4rem 0; border-bottom: 1px solid var(--border);
  font-size: .9rem;
}
.results-breakdown .row:last-child { border: none; }
.results-actions { margin-top: 1.5rem; display: flex; gap: .75rem; justify-content: center; flex-wrap: wrap; }

/* â”€â”€â”€â”€â”€ Responsive â”€â”€â”€â”€â”€ */
@media (max-width: 600px) {
  body { padding: 1rem; }
  .hero h1 { font-size: 1.5rem; }
  .question-card { padding: 1.25rem; }
  .q-text { font-size: 1rem; }
}

/* â”€â”€â”€â”€â”€ Iframe Quiz Layout â”€â”€â”€â”€â”€ */
.frame-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  min-height: 300px;
}

.question-iframe {
  width: 100%;
  min-height: 300px;
  border: none;
  display: block;
  transition: height .2s ease;
}

.quiz-footer {
  display: flex;
  justify-content: flex-end;
  padding: .75rem 0;
}

/* â”€â”€â”€â”€â”€ Study Mode â”€â”€â”€â”€â”€ */
#studyView {
  max-width: 900px;
  margin: 0 auto;
}
.study-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 1.5rem; padding-bottom: .75rem;
  border-bottom: 1px solid var(--border);
}
.study-header h2 {
  font-size: 1.5rem; font-weight: 700;
}
.study-questions {
  display: flex; flex-direction: column; gap: 2rem;
}
.study-question-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
}
.study-question-card iframe {
  width: 100%;
  min-height: 400px;
  border: none;
  display: block;
}

/* â”€â”€â”€â”€â”€ Progress History â”€â”€â”€â”€â”€ */
.progress-history {
  margin-top: 2rem;
  padding: 1.5rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
}
.progress-history h3 {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: var(--text);
}
.history-list {
  display: flex;
  flex-direction: column;
  gap: .75rem;
}
.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: .75rem 1rem;
  background: var(--surface2);
  border-radius: var(--radius);
  font-size: .9rem;
}
.history-item .score {
  font-weight: 600;
  color: var(--primary);
}
.history-item .chapter-name {
  color: var(--text-dim);
  font-size: .85rem;
}
.history-empty {
  color: var(--text-dim);
  font-size: .9rem;
  text-align: center;
  padding: 1rem;
}
</style>
</head>
<body>
  <!-- Landing view -->
  <div id="landingView" class="view active">
    <header class="hero">
      <h1>Stochastic Processes in Finance</h1>
      <p class="subtitle">110 questions to sharpen your understanding â€” chapter by chapter</p>
    </header>

    <div class="chapter-grid" id="chapterGrid"></div>

    <div class="cta-row">
      <button class="btn btn-primary btn-lg" id="startAllBtn">ğŸ² Start Quiz - ALL Chapters</button>
    </div>
  </div>

  <!-- Study view -->
  <div id="studyView" class="view">
    <div class="study-header">
      <h2 id="studyTitle">Study Mode</h2>
      <a href="?" class="btn btn-ghost">â† Back to Chapters</a>
    </div>
    <div class="study-questions" id="studyQuestions"></div>
  </div>

  <!-- Quiz view -->
  <div id="quizView" class="view">
    <div class="quiz-header">
      <a href="?" class="btn btn-ghost">â† Chapters</a>
      <div class="progress-wrap">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <span class="progress-text" id="progressText">1 / 10</span>
      <span class="score-text" id="scoreText">Score: 0</span>
      <button class="btn btn-primary hidden" id="nextBtn">Next â†’</button>
    </div>

    <div class="frame-wrap">
      <div id="jumpNav" class="jump-nav hidden"></div>
      <iframe id="questionFrame" class="question-iframe" sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
    </div>
  </div>

  <!-- Results view -->
  <div id="resultsView" class="view">
    <div class="results-card">
      <h2>Quiz Complete</h2>
      <div class="results-score" id="resultsScore"></div>
      <div class="results-breakdown" id="resultsBreakdown"></div>
      <div class="results-actions">
        <button class="btn btn-primary" id="retryWrong">Retry Wrong Answers</button>
        <button class="btn btn-ghost" id="backToChapters">Back to Chapters</button>
      </div>
    </div>

    <div class="progress-history" id="progressHistory" style="display: none;">
      <h3>ğŸ“Š Quiz History</h3>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>

  <script src="registry.js"></script>
  <script>
/* â”€â”€ Landing Page â”€â”€ */
(function initLanding() {
  const grid = document.getElementById('chapterGrid');
  chapters.forEach(ch => {
    const card = document.createElement('div');
    card.className = 'chapter-card';

    const best = (() => {
      try { return JSON.parse(localStorage.getItem('stoch_best_' + ch.id) || '{}'); } catch(_) { return {}; }
    })();
    const pct = best.best ? Math.round((best.best / best.total) * 100) : 0;

    card.innerHTML =
      '<h3>' + ch.title + '</h3>' +
      '<div class="meta">' + ch.questions.length + ' questions' + (best.best ? ' Â· Best: ' + best.best + '/' + best.total : '') + '</div>' +
      '<div class="bar-bg"><div class="bar-fill" style="width:' + pct + '%"></div></div>' +
      '<div class="chapter-actions">' +
        '<button class="btn btn-primary start-quiz-btn" data-chapter="' + ch.id + '">Start Quiz</button>' +
        '<button class="btn btn-study study-btn" data-chapter="' + ch.id + '" title="Study Mode">â„¹ï¸</button>' +
      '</div>';
    grid.appendChild(card);
  });

  // Add event listeners for start quiz buttons
  document.querySelectorAll('.start-quiz-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const chapterId = e.target.dataset.chapter;
      location.href = '?random=' + chapterId + '&n=10';
    });
  });

  // Add event listeners for study mode buttons
  document.querySelectorAll('.study-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const chapterId = e.target.dataset.chapter;
      location.href = '?study=' + chapterId;
    });
  });

  // Add event listener for ALL button
  const startAllBtn = document.getElementById('startAllBtn');
  if (startAllBtn) {
    startAllBtn.addEventListener('click', () => {
      const allChapterIds = chapters.map(ch => ch.id).join(',');
      location.href = '?random=' + allChapterIds + '&n=10';
    });
  }
})();

/* â”€â”€ Study Mode â”€â”€ */
(function initStudy() {
  const params = new URLSearchParams(location.search);
  const studyParam = params.get('study');
  if (!studyParam) return;

  const studyView = document.getElementById('studyView');
  const landingView = document.getElementById('landingView');
  const quizView = document.getElementById('quizView');
  const resultsView = document.getElementById('resultsView');

  // Show study view
  landingView.classList.remove('active');
  studyView.classList.add('active');
  quizView.classList.remove('active');
  resultsView.classList.remove('active');

  const chapterId = parseInt(studyParam);
  const chapter = chapters.find(c => c.id === chapterId);
  if (!chapter) {
    location.href = '?';
    return;
  }

  // Set title
  document.getElementById('studyTitle').textContent = chapter.title + ' â€” Study Mode';
  document.title = chapter.title + ' â€” Study Mode';

  // Load all questions
  const studyQuestions = document.getElementById('studyQuestions');
  const sortedQuestions = [...chapter.questions].sort((a, b) => {
    const [ac, aq] = a.split('.').map(Number);
    const [bc, bq] = b.split('.').map(Number);
    return ac !== bc ? ac - bc : aq - bq;
  });

  sortedQuestions.forEach(qId => {
    const card = document.createElement('div');
    card.className = 'study-question-card';

    const iframe = document.createElement('iframe');
    iframe.className = 'question-iframe';
    iframe.sandbox = 'allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox';

    const filename = qId.replace('.', '-') + '.html';
    const embedded = window.__embeddedQuestions && window.__embeddedQuestions[filename];
    if (embedded) {
      iframe.srcdoc = embedded;
    } else {
      iframe.src = 'questions/' + filename;
    }

    // Listen for resize messages to adjust iframe height
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'resize') {
        // Find the iframe that sent this message
        iframe.style.height = e.data.height + 'px';
      }
    });

    card.appendChild(iframe);
    studyQuestions.appendChild(card);
  });
})();

/* â”€â”€ Quiz Runner â”€â”€ */
(function initQuiz() {
  /* â”€â”€ State â”€â”€ */
  let questionIds = [];
  let currentIndex = 0;
  let score = 0;
  let answers = {};   // { [questionId]: boolean }
  let chapterId = null;
  let isChapterMode = false;

  /* â”€â”€ DOM â”€â”€ */
  const $ = id => document.getElementById(id);
  const landingView = $('landingView');
  const quizView    = $('quizView');
  const resultsView = $('resultsView');
  const iframe      = $('questionFrame');
  const progressBar = $('progressBar');
  const progressTxt = $('progressText');
  const scoreTxt    = $('scoreText');
  const nextBtn     = $('nextBtn');
  const jumpNav     = $('jumpNav');
  const retryBtn    = $('retryWrong');
  const backBtn     = $('backToChapters');
  const quizHeader  = quizView.querySelector('.quiz-header');

  /* â”€â”€ Init â”€â”€ */
  function init() {
    const params = new URLSearchParams(location.search);
    const randomParam  = params.get('random');

    if (!randomParam) {
      landingView.classList.add('active');
      quizView.classList.remove('active');
      resultsView.classList.remove('active');
      return;
    }

    landingView.classList.remove('active');
    quizView.classList.add('active');
    resultsView.classList.remove('active');

    // Random quiz mode
    isChapterMode = false;
    const chapIds = randomParam === 'all'
      ? chapters.map(c => c.id)
      : randomParam.split(',').map(Number);
    const pool = chapters
      .filter(c => chapIds.includes(c.id))
      .flatMap(c => c.questions);
    const n = Math.max(1, parseInt(params.get('n') || '10'));
    questionIds = shuffle([...pool]).slice(0, Math.min(n, pool.length));
    chapterId = chapIds.length === 1 ? chapIds[0] : 'random';
    document.title = 'Random Quiz â€” Stochastic Processes';

    currentIndex = 0;
    score = 0;
    answers = {};

    nextBtn.addEventListener('click', nextQuestion);
    retryBtn.addEventListener('click', retryWrong);
    backBtn.addEventListener('click', () => location.href = '?');
    window.addEventListener('message', onMessage);

    loadQuestion();
  }

  /* â”€â”€ Load current question in iframe â”€â”€ */
  function loadQuestion() {
    nextBtn.classList.add('hidden');
    const id = questionIds[currentIndex];
    const filename = id.replace('.', '-') + '.html';
    const embedded = window.__embeddedQuestions && window.__embeddedQuestions[filename];
    if (embedded) {
      iframe.removeAttribute('src');
      iframe.srcdoc = embedded;
    } else {
      iframe.removeAttribute('srcdoc');
      iframe.src = 'questions/' + filename;
    }
    updateProgress();
  }

  /* â”€â”€ Listen for postMessage from question iframe â”€â”€ */
  function onMessage(e) {
    if (!e.data || typeof e.data !== 'object') return;

    if (e.data.type === 'answered') {
      const { id, correct } = e.data;
      answers[id] = correct;
      score = Object.values(answers).filter(Boolean).length;

      scoreTxt.textContent = `Score: ${score}`;
      nextBtn.textContent = currentIndex < questionIds.length - 1 ? 'Next â†’' : 'See Results';
      nextBtn.classList.remove('hidden');
    }

    if (e.data.type === 'resize') {
      const headerH = quizHeader?.offsetHeight || 0;
      const bodyStyles = getComputedStyle(document.body);
      const paddingV = parseFloat(bodyStyles.paddingTop || '0') + parseFloat(bodyStyles.paddingBottom || '0');
      const availableHeight = window.innerHeight - headerH - paddingV;
      const targetHeight = Math.max(e.data.height, availableHeight);
      iframe.style.height = targetHeight + 'px';
    }
  }

  /* â”€â”€ Next question â”€â”€ */
  function nextQuestion() {
    currentIndex++;
    if (currentIndex >= questionIds.length) {
      showResults();
    } else {
      loadQuestion();
    }
  }

  /* â”€â”€ Progress bar â”€â”€ */
  function updateProgress() {
    const total = questionIds.length;
    progressBar.style.width = `${((currentIndex + 1) / total) * 100}%`;
    progressTxt.textContent = `${currentIndex + 1} / ${total}`;
    scoreTxt.textContent = `Score: ${score}`;
  }

  /* â”€â”€ Results â”€â”€ */
  function showResults() {
    quizView.classList.remove('active');
    resultsView.classList.add('active');

    const total = questionIds.length;
    const pct = total > 0 ? Math.round((score / total) * 100) : 0;
    $('resultsScore').textContent = `${score} / ${total}  (${pct}%)`;

    saveBest(chapterId, score, total);
    saveQuizHistory(chapterId, score, total);

    const bd = $('resultsBreakdown');
    bd.innerHTML = '';
    const byChapter = {};
    Object.keys(answers).forEach(id => {
      const chNum = id.split('.')[0];
      if (!byChapter[chNum]) byChapter[chNum] = { correct: 0, total: 0 };
      byChapter[chNum].total++;
      if (answers[id]) byChapter[chNum].correct++;
    });
    Object.keys(byChapter).sort((a, b) => +a - +b).forEach(chNum => {
      const ch = chapters.find(c => c.id === +chNum);
      const { correct, total } = byChapter[chNum];
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `<span>${ch ? ch.title : 'Ch ' + chNum}</span><span>${correct}/${total}</span>`;
      bd.appendChild(row);
    });

    const wrongCount = Object.keys(answers).filter(id => !answers[id]).length;
    retryBtn.classList.toggle('hidden', wrongCount === 0);

    // Display quiz history
    displayQuizHistory();
  }

  function saveBest(chId, score, total) {
    if (!total) return;
    const key = 'stoch_best_' + chId;
    try {
      const prev = JSON.parse(localStorage.getItem(key) || '{}');
      const best = Math.max(prev.best || 0, score);
      localStorage.setItem(key, JSON.stringify({ best, total }));
    } catch (_) {}
  }

  function saveQuizHistory(chId, score, total) {
    try {
      const history = JSON.parse(localStorage.getItem('stoch_quiz_history') || '[]');
      const byChapter = {};
      Object.keys(answers).forEach(id => {
        const chNum = id.split('.')[0];
        if (!byChapter[chNum]) byChapter[chNum] = { correct: 0, total: 0 };
        byChapter[chNum].total++;
        if (answers[id]) byChapter[chNum].correct++;
      });

      const entry = {
        timestamp: Date.now(),
        chapterId: chId,
        score: score,
        total: total,
        breakdown: byChapter
      };

      history.push(entry);
      // Keep only last 20 entries
      if (history.length > 20) {
        history.shift();
      }
      localStorage.setItem('stoch_quiz_history', JSON.stringify(history));
    } catch (_) {}
  }

  function displayQuizHistory() {
    try {
      const history = JSON.parse(localStorage.getItem('stoch_quiz_history') || '[]');
      const historyContainer = $('progressHistory');
      const historyList = $('historyList');

      if (history.length === 0) {
        historyContainer.style.display = 'none';
        return;
      }

      historyContainer.style.display = 'block';
      historyList.innerHTML = '';

      // Show last 10 entries in reverse order (newest first)
      history.slice(-10).reverse().forEach(entry => {
        const item = document.createElement('div');
        item.className = 'history-item';

        const date = new Date(entry.timestamp);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        let chapterNames = '';
        if (entry.chapterId === 'random') {
          const chapterIds = Object.keys(entry.breakdown);
          if (chapterIds.length === 1) {
            const ch = chapters.find(c => c.id === +chapterIds[0]);
            chapterNames = ch ? ch.title : 'Chapter ' + chapterIds[0];
          } else {
            chapterNames = 'Multiple Chapters';
          }
        } else {
          const ch = chapters.find(c => c.id === +entry.chapterId);
          chapterNames = ch ? ch.title : 'Chapter ' + entry.chapterId;
        }

        item.innerHTML = `
          <div>
            <div class="score">${entry.score}/${entry.total}</div>
            <div class="chapter-name">${chapterNames}</div>
          </div>
          <div style="font-size: .8rem; color: var(--text-dim);">${dateStr}</div>
        `;
        historyList.appendChild(item);
      });
    } catch (_) {
      $('progressHistory').style.display = 'none';
    }
  }

  /* â”€â”€ Retry wrong answers â”€â”€ */
  function retryWrong() {
    const wrongIds = Object.keys(answers).filter(id => !answers[id]);
    questionIds = shuffle(wrongIds);
    currentIndex = 0;
    score = 0;
    answers = {};
    isChapterMode = false;
    resultsView.classList.remove('active');
    quizView.classList.add('active');
    loadQuestion();
  }

  /* â”€â”€ Helpers â”€â”€ */
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  init();
})();
  </script>
</body>
</html>
